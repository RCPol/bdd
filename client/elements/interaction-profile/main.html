<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="/bower_components/polymer/polymer.html">

<script src="/bower_components/d3/d3.js"></script>
<script src="/bower_components/d3-plugins-sankey/sankey.js"></script>
<script src="/bower_components/d3.chart/d3.chart.js"></script>
<script src="/javascript/d3.chart.sankey.js"></script>

<!--<link rel="stylesheet" href="/ffub/DQProfile/main.scss">-->

<dom-module id="interaction-profile">  
  <template>       
      <!-- Título da Página -->
		<h1 class="pal">Espécies de plantas visitadas por <i>{{pollinator}}</i> Determinador</h1>

		<!-- Seletor do gráfico -->
		<div class="graf-e">

			<p> Selecionar Região:
			<select class="opcoes-select">
				<option value="">Brasil</option>
				<option value="">Centro-Oeste</option>
				<option value="">Nordeste</option>
				<option value="">Norte</option>
				<option value="">Sul</option>
				<option value="">Sudeste</option>
			</select>
			</p>

		</div>

		<!-- Gráfico -->
		<div class="graf">

		<div style="height:900px" id="chart"></div>

		</div>

		<!-- Início: Referências -->
		<div class="rre">
			
			<h2>Refer&ecirc;ncias Bibliogr&aacute;ficas:</h2>
                <template id="vis" is="dom-repeat" items="{{references}}">
                    <p>teste: {{item.ref}}</p>
                </template>
					<p>Barth, O. M., & Barbosa, A. F. (1972). Catálogo sistemático dos pólens das plantas arbóreas do Brasil meridional XV. Myrtaceae. Memórias do Instituto Oswaldo Cruz, 70(4), 467-496.</p>

					<p>Evaldt, A. C. P., Bauermann, S. G., Fuchs, S. C. B., Diesel, S., & Cancelli, R. R. (2009). Grãos de pólen e esporos do Vale do Rio Caí, nordeste do Rio Grande do Sul, Brasil: descrições morfológicas e implicações paleoecológicas. Gaea-Journal of Geoscience, 5(2), 86-106.</p>

		</div>
		<!-- Final: Referências -->
  </template>
</dom-module>
<script>
  Polymer({
    is: "interaction-profile",    
    properties:{    
        pollinator: String,    
        interactions: Array,
        references: Array
    },
    ready: function(){        
        var self = this;                  
        $.getJSON( "/api/Interactions/findOne?pollinator="+self.pollinator, function( interaction ) {
            self.references = [];
            if(interaction.reference)
                self.references.push({ref:interaction.reference});  
           console.log(self.references[0]);         
        });
        self.load();
    },
    load: function(){
        var self = this;                
        $.getJSON( "/api/Interactions/plants?pollinator="+self.pollinator, function( interactions ) {                                                     
            // IN
            var json = {nodes: [], links:[]};
            var data = interactions.response.map(function(item){
                var d = {
                    species: item._id.plant?item._id.plant:"", 
                    value: item.avgQuantity?item.avgQuantity:0, 
                    region: item._id.region?item._id.region:"", 
                    state: item._id.state?item._id.state:"", 
                    municipality: item._id.municipality?item._id.municipality:""};                
                return d;
            });
            // console.log(interact);
            // var data = [];
            // data.push({species:"Montanoa bipinnatifida", value:80, region:"Sul", state:"Paraná", municipality:"Foz do Iguaçu"});      
            // data.push({species:"Montanoa bipinnatifida", value:70, region:"Sul", state:"Paraná", municipality:"Cascavel"});
            // data.push({species:"Montanoa bipinnatifida", value:10, region:"Sul", state:"Santa Catarina", municipality:"Florianópolis"});        
            // data.push({species:"Montanoa bipinnatifida", value:60, region:"Sul", state:"Santa Catarina", municipality:"Itajaí"});
            // data.push({species:"Montanoa bipinnatifida", value:30, region:"Nordeste", state:"Bahia", municipality:"Salvador"});
            // data.push({species:"Eugenia uniflora", value:50, region:"Sul", state:"Paraná", municipality:"Curitiba"});        
            // data.push({species:"Eugenia uniflora", value:50, region:"Sul", state:"Paraná", municipality:"Foz do Iguaçu"});        
            // data.push({species:"Handroanthus chrysotrichus", value:10, region:"Sul", state:"Santa Catarina", municipality:"Florianópolis"});              
            // data.push({species:"Handroanthus chrysotrichus", value:99, region:"Sul", state:"Paraná", municipality:"Curitiba"});            
            // data.push({species:"Handroanthus chrysotrichus", value:10, region:"Sul", state:"Paraná", municipality:"Cascavel"}); 
            // data.push({species:"Handroanthus chrysotrichus", value:90, region:"Nordeste", state:"Bahia", municipality:"Salvador"});   
            // data.push({species:"Handroanthus chrysotrichus", value:40, region:"Norte", state:"Pará", municipality:"Belém"});            
            // data.push({species:"Citrus limonia", value:40, region:"Norte", state:"Pará", municipality:"Belém"});            
            data.forEach(function(item){
                if(self.index(json.nodes,item.species)==-1)
                json.nodes.push({name:item.species});
                if(self.index(json.nodes,item.municipality)==-1)
                json.nodes.push({name:item.municipality});
                if(self.index(json.nodes,item.state)==-1)
                json.nodes.push({name:item.state});
                if(self.index(json.nodes,item.region)==-1)
                json.nodes.push({name:item.region});
            });
            // Link Specie - Cidade
            data.forEach(function(item){
                var s = self.index(json.nodes, item.municipality);
                var t = self.index(json.nodes, item.species);
                var v = item.value;
                var link = {"source": s, "target":t, "value": v};
                json.links.push(link);
            });
            // Link Cidade - Estado
            data.forEach(function(item){
                var s = self.index(json.nodes, item.state);
                var t = self.index(json.nodes, item.municipality);
                var v = item.value;
                var link = {"source": s, "target": t, "value": v};
                json.links.push(link);
            });
            // Link Estado - Região
            data.forEach(function(item){
                var s = self.index(json.nodes, item.region);
                var t = self.index(json.nodes, item.state);
                var v = item.value;
                var link = {"source": s, "target": t, "value": v};
                json.links.push(link);        
            });
            
            var chart = d3.select("#chart").append("svg").chart("Sankey.Path");        
            // chart.colorLinks(function(link) { return  '#F9C6A7'; }).draw(json);            
            chart.draw(json);
        });        
    },
    index: function(data, value){        
        for(var i = 0; i < data.length; i++){
          if(data[i].name == value)
            return i;
        }
        return -1;        
      }    
  });

</script>